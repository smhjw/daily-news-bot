import os
import smtplib
import requests
import google.generativeai as genai
from email.mime.text import MIMEText
from email.header import Header
from datetime import datetime

# --- é…ç½®åŒºåŸŸ ---
NEWS_API_KEY = os.environ["NEWS_API_KEY"]
EMAIL_USER = os.environ["EMAIL_USER"]
EMAIL_PASS = os.environ["EMAIL_PASSWORD"]
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY") # è·å– AI Key

TARGET_EMAIL = EMAIL_USER

# é…ç½® Gemini
if GEMINI_API_KEY:
    genai.configure(api_key=GEMINI_API_KEY)
    # ä½¿ç”¨ flash æ¨¡å‹ï¼Œé€Ÿåº¦å¿«ä¸”å…è´¹é¢åº¦é«˜
    model = genai.GenerativeModel('gemini-pro')

def get_news():
    # è·å–å…¨çƒç§‘æŠ€/å•†ä¸šæ–°é—» (ä½ å¯ä»¥æ”¹ category=general)
    url = f"https://newsapi.org/v2/top-headlines?country=us&category=general&pageSize=7&apiKey={NEWS_API_KEY}"
    try:
        response = requests.get(url)
        data = response.json()
        return data.get("articles", [])
    except Exception as e:
        print(f"è·å–æ–°é—»å¤±è´¥: {e}")
        return []

def ai_summarize(title, description):
    """è°ƒç”¨ Gemini è¿›è¡Œç¿»è¯‘å’Œæ€»ç»“"""
    if not GEMINI_API_KEY:
        return description # å¦‚æœæ²¡é…ç½® Keyï¼Œå°±è¿”å›åŸç‰ˆ

    try:
        # ç»™ AI çš„æŒ‡ä»¤ (Vibe Prompt)
        # Vibe Prompt 2.0: æ‹’ç»ç¿»è¯‘è…”ï¼Œæ›´åƒäººè¯
        prompt = f"""
        ä½ æ˜¯ä¸€ä½æœ‰ç€10å¹´ç»éªŒçš„èµ„æ·±å›½é™…æ–°é—»ç¼–è¾‘ã€‚
        è¯·é˜…è¯»ä»¥ä¸‹è‹±æ–‡æ–°é—»ï¼Œç”¨**æœ€åœ°é“ã€æœ€ç¬¦åˆä¸­å›½äººé˜…è¯»ä¹ æƒ¯**çš„ä¸­æ–‡é‡å†™ä¸€æ®µç®€æŠ¥ï¼ˆ100å­—ä»¥å†…ï¼‰ã€‚
        
        å…³é”®è¦æ±‚ï¼š
        1. ğŸš« **æ‹’ç»ç¿»è¯‘è…”**ï¼šä¸¥ç¦é€å­—ç›´è¯‘ï¼ä¸è¦å‡ºç°â€œå®ƒæ˜¯è¢«...â€è¿™ç§è¢«åŠ¨å¥æ€ã€‚
        2. ğŸ—£ï¸ **è¯´äººè¯**ï¼šç”¨ä¸­æ–‡çš„é€»è¾‘é‡æ–°ç»„ç»‡è¯­è¨€ï¼Œè¯»èµ·æ¥è¦é¡ºå£ã€è‡ªç„¶ã€‚
        3. ğŸ¯ **æŠ“é‡ç‚¹**ï¼šç›´æ¥å‘Šè¯‰è¯»è€…å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Œçœç•¥æ¬¡è¦çš„ä¿®é¥°è¯ã€‚
        
        è‹±æ–‡æ ‡é¢˜: {title}
        è‹±æ–‡ç®€ä»‹: {description}
        
        ä¸­æ–‡æ‘˜è¦ï¼š
        """
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"AI æ€»ç»“å¤±è´¥: {e}")
        return description # å¤±è´¥å›é€€

def send_email(articles):
    if not articles:
        print("æ²¡æœ‰æ–°é—»å¯å‘")
        return

    today = datetime.now().strftime("%Y-%m-%d %A")
    print(f"æ­£åœ¨å¤„ç† {len(articles)} æ¡æ–°é—»ï¼ŒAI æ­£åœ¨é˜…è¯»ä¸­... (è¿™å¯èƒ½éœ€è¦å‡ åç§’)")

    # --- é‚®ä»¶å¤´éƒ¨ ---
    html_content = f"""
    <html>
    <body style="font-family: 'Helvetica Neue', Helvetica, 'Microsoft YaHei', sans-serif; background-color: #f4f4f4; padding: 20px;">
        <div style="max-width: 600px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 25px;">
                <h1 style="color: #000; font-size: 26px; margin: 0;">ğŸŒ å…¨çƒæ—©æŠ¥ (AI ç‰ˆ)</h1>
                <p style="color: #666; font-size: 14px; margin-top: 5px;">{today} | Gemini æ•´ç†</p>
            </div>
    """

    # --- å¾ªç¯å¤„ç†æ¯æ¡æ–°é—» ---
    for article in articles:
        title_en = article.get('title', 'æ— æ ‡é¢˜')
        desc_en = article.get('description', '')
        url = article.get('url')
        source = article.get('source', {}).get('name', 'Unknown')

        if title_en == "[Removed]": continue

        # === å…³é”®æ­¥éª¤ï¼šå¬å”¤ AI ===
        # ä¼ å…¥æ ‡é¢˜å’Œç®€ä»‹ï¼Œè·å–ä¸­æ–‡æ€»ç»“
        summary_cn = ai_summarize(title_en, desc_en)

        html_content += f"""
            <div style="margin-bottom: 30px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border-left: 4px solid #007bff;">
                <h3 style="margin: 0 0 10px 0; font-size: 18px; line-height: 1.4;">
                    <a href="{url}" style="color: #2c3e50; text-decoration: none;">{title_en}</a>
                </h3>
                <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                    æ¥æº: {source}
                </div>
                <p style="color: #333; font-size: 15px; line-height: 1.6; margin: 0;">
                    <strong>ğŸ’¡ AI åˆ’é‡ç‚¹ï¼š</strong> {summary_cn}
                </p>
            </div>
        """

    html_content += """
            <div style="margin-top: 30px; text-align: center; color: #aaa; font-size: 12px;">
                Generated by GitHub Actions & Google Gemini
            </div>
        </div>
    </body>
    </html>
    """

    # --- å‘é€é€»è¾‘ ---
    msg = MIMEText(html_content, 'html', 'utf-8')
    msg['From'] = Header("AI News Bot", 'utf-8')
    msg['To'] = TARGET_EMAIL
    msg['Subject'] = Header(f"æ—©å®‰ï¼ä»Šæ—¥å…¨çƒè¦é—» ({today})", 'utf-8')

    try:
        server = smtplib.SMTP_SSL("smtp.gmail.com", 465)
        server.login(EMAIL_USER, EMAIL_PASS)
        server.sendmail(EMAIL_USER, [TARGET_EMAIL], msg.as_string())
        server.quit()
        print("âœ… é‚®ä»¶å‘é€æˆåŠŸï¼")
    except Exception as e:
        print(f"âŒ å‘é€å¤±è´¥: {e}")

if __name__ == "__main__":
    articles = get_news()
    send_email(articles)
